<html>
  <head>
  </head>
  <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="text/javascript"> </script>
  <script src="zepto.min.js" type="text/javascript"> </script>
  <script type="text/javascript">
    //Edit this \/
    const factory_addr="0xf6b6732f5f7859defb73399e246438f56925fc99";
    const factory_abi=[ { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "_registries", "outputs": [ { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "address", "name": "addy", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "string", "name": "location", "type": "string" }, { "internalType": "string", "name": "date", "type": "string" }, { "internalType": "address", "name": "registry", "type": "address" } ], "name": "create_attendance", "outputs": [ { "internalType": "contract Attendance", "name": "", "type": "address" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "attestation", "type": "string" }, { "internalType": "address", "name": "registry", "type": "address" } ], "name": "create_free_form", "outputs": [ { "internalType": "contract FreeForm", "name": "", "type": "address" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "child_name", "type": "string" }, { "internalType": "address", "name": "parent", "type": "address" } ], "name": "create_registry", "outputs": [ { "internalType": "contract Registry", "name": "", "type": "address" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "init", "outputs": [ { "internalType": "contract Factory", "name": "", "type": "address" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "registries", "outputs": [ { "components": [ { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "address", "name": "addy", "type": "address" } ], "internalType": "struct reg[]", "name": "", "type": "tuple[]" } ], "stateMutability": "view", "type": "function" } ];
    const registry_abi=[ { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "_attestations", "outputs": [ { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "address", "name": "addy", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "_registries", "outputs": [ { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "address", "name": "addy", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "attestations", "outputs": [ { "components": [ { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "address", "name": "addy", "type": "address" } ], "internalType": "struct reg[]", "name": "", "type": "tuple[]" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "name_", "type": "string" } ], "name": "init", "outputs": [ { "internalType": "contract Registry", "name": "", "type": "address" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "name", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "attestation", "type": "string" }, { "internalType": "address", "name": "child", "type": "address" } ], "name": "register_attestation", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "contract Registry", "name": "parent", "type": "address" } ], "name": "register_in_parent", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "contract Registry", "name": "child", "type": "address" } ], "name": "register_registry", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "registries", "outputs": [ { "components": [ { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "address", "name": "addy", "type": "address" } ], "internalType": "struct reg[]", "name": "", "type": "tuple[]" } ], "stateMutability": "view", "type": "function" } ];
    const zero_addr="0x0000000000000000000000000000000000000000";
    var provider, signer, factory_ro, factory_rw;
    //poor man's html factory
    ['h1','h2','h3','div','p','ul','li','button','a'].forEach((tag) => {
      window[tag]=(attrs, content="") => {
        return $('<'+tag+' />', attrs).append(content);
      }
    })
    //this is quite ugly, but seems the least of the available uglies
    Zepto(function($){$('body').append(div({id: factory_addr}))})

    //populate a registry when clicked
    $(document).on('click', 'button.expand', function (e) {
      var par_reg=$(e.target).parent('.registry').attr('id');
      var par_name=$(e.target).parent('.registry').attr('name');
      get_registries(par_reg).then((regs) => show_registries(regs, par_reg, par_name));
    })

    function mm_connect() {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      factory_ro=new ethers.Contract(factory_addr, factory_abi, provider);
      factory_rw=new ethers.Contract(factory_addr, factory_abi, signer);
      $('#mm_connect').hide();
      get_registries().then((regs) => show_registries(regs));
    }

    function new_registry(parent=zero_addr){
      if (parent == factory_addr) {parent=zero_addr} //This is for top level registries
      name=prompt("Name");
      if (name > ""){factory_rw.create_registry(name, parent);}
    }

    function get_freeforms(registry){
      return new ethers.Contract(registry, registry_abi, provider).freeforms();
    }
    function show_freeforms(attestations, addr, name){
    }
    function get_attendances(registry){
    }
    function show_attendances(attestations, addr, name){
    }

    function get_registries(registry=factory_addr){
      return new ethers.Contract(registry, registry_abi, provider).registries();
    }
    function show_registries(registries, addr=factory_addr, name="Top Level"){
      $('#'+addr).append(div({class: "registry", id: addr},[
        h2(name),
        button({onclick: "new_registry('"+addr+"')"}, "New registry under " + name),
        ul({class: "registries"}, registries.map((reg) => li({id: reg.addy, name: reg.name, class: "registry"},  [button({class: 'expand'}, '+'), reg.name])))
      ]));
    }

    function get_reg_address(raddr,reg){
      return new ethers.Contract(raddr, registry_abi, provider).registries(reg);
    }
  </script>
  <body>
    <h1>Attestation Management</h1>
    <button id="mm_connect" onclick="mm_connect()">Connect to wallet</button>
  </body>
</html>
